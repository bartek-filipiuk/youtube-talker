---
/**
 * Create New Channel Page
 *
 * Form to create a new channel with:
 * - Name (slug format, lowercase, hyphens)
 * - Display title
 * - Description (optional)
 */

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { requireAdmin } from '../../../lib/admin-auth';

// Auth check
const auth = await requireAdmin(Astro);
if (auth instanceof Response) return auth;
---

<AdminLayout title="Create New Channel" auth={auth}>
  <div class="max-w-2xl">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Create New Channel</h1>
      <p class="text-gray-600 mt-1">Add a new channel to organize videos by topic</p>
    </div>

    <!-- Back Link -->
    <a
      href="/admin/channels"
      class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-6"
    >
      ‚Üê Back to Channels
    </a>

    <!-- Form Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <form id="create-channel-form" class="space-y-6">
        <!-- Channel Name (Slug) -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
            Channel Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            pattern="[a-z0-9-]+"
            placeholder="e.g., web-development"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">
            Lowercase letters, numbers, and hyphens only. This will be used in URLs.
          </p>
        </div>

        <!-- Display Title -->
        <div>
          <label for="display_title" class="block text-sm font-medium text-gray-700 mb-2">
            Display Title <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="display_title"
            name="display_title"
            required
            placeholder="e.g., Web Development Tutorials"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">
            User-friendly title shown in the UI.
          </p>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
            Description <span class="text-gray-400">(optional)</span>
          </label>
          <textarea
            id="description"
            name="description"
            rows="4"
            placeholder="e.g., Learn web development with tutorials on React, Vue, and more..."
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">
            Brief description of the channel's content.
          </p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm"></div>

        <!-- Form Actions -->
        <div class="flex space-x-3">
          <button
            type="submit"
            id="submit-btn"
            class="px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Create Channel
          </button>
          <a
            href="/admin/channels"
            class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 transition"
          >
            Cancel
          </a>
        </div>
      </form>
    </div>

    <!-- Info Box -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-md p-4">
      <h3 class="text-sm font-semibold text-blue-900 mb-2">üìå What happens after creation?</h3>
      <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
        <li>A Qdrant collection will be created automatically</li>
        <li>You can add videos to the channel immediately</li>
        <li>Users can chat with the channel's video content</li>
      </ul>
    </div>
  </div>

  <!-- Form Submission Script -->
  <script>
    import { createChannel } from '../../../lib/admin-api';
    import { getClientToken, showToast } from '../../../lib/admin-auth';

    const form = document.getElementById('create-channel-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;

    // Get auth token
    const token = getClientToken();

    if (!token) {
      errorMessage.textContent = 'Authentication required. Please log in again.';
      errorMessage.classList.remove('hidden');
      submitBtn.disabled = true;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!token) return;

      // Get form data
      const formData = new FormData(form);
      const name = (formData.get('name') as string).trim().toLowerCase();
      const display_title = (formData.get('display_title') as string).trim();
      const description = (formData.get('description') as string).trim() || undefined;

      // Validate name format
      if (!/^[a-z0-9-]+$/.test(name)) {
        errorMessage.textContent = 'Channel name must contain only lowercase letters, numbers, and hyphens.';
        errorMessage.classList.remove('hidden');
        return;
      }

      // Hide previous errors
      errorMessage.classList.add('hidden');

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        // Create channel
        await createChannel(token, {
          name,
          display_title,
          description,
        });

        // Success - redirect to channels list
        showToast('Channel created successfully! Redirecting...', 'success');
        setTimeout(() => {
          window.location.href = '/admin/channels';
        }, 1500);
      } catch (error) {
        console.error('Failed to create channel:', error);
        errorMessage.textContent = `Failed to create channel: ${error}`;
        errorMessage.classList.remove('hidden');

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Channel';
      }
    });
  </script>
</AdminLayout>
