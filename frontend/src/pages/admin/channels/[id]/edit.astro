---
/**
 * Edit Channel Page
 *
 * Form to edit existing channel:
 * - Display title (editable)
 * - Description (editable)
 * - Name is read-only (URL slug, cannot be changed)
 */

import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { requireAdmin } from '../../../../lib/admin-auth';
import { getChannel, type Channel } from '../../../../lib/admin-api';

// Auth check
const auth = await requireAdmin(Astro);
if (auth instanceof Response) return auth;

// Get channel ID from URL
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/channels');
}

// Fetch channel data
let channel: Channel | null = null;
let error: string | null = null;

try {
  channel = await getChannel(auth.token, id);
} catch (err) {
  console.error('Failed to fetch channel:', err);
  error = 'Failed to load channel. Please try again.';
}

// If channel not found or error, redirect back
if (!channel) {
  return Astro.redirect('/admin/channels?error=channel_not_found');
}
---

<AdminLayout title={`Edit ${channel.display_title}`} auth={auth}>
  <div class="max-w-2xl">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Edit Channel</h1>
      <p class="text-gray-600 mt-1">Update channel information</p>
    </div>

    <!-- Back Link -->
    <a
      href="/admin/channels"
      class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-6"
    >
      ‚Üê Back to Channels
    </a>

    <!-- Form Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <form id="edit-channel-form" class="space-y-6">
        <!-- Channel ID (Hidden) -->
        <input type="hidden" name="channel_id" value={channel.id} />

        <!-- Channel Name (Read-only) -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
            Channel Name
          </label>
          <input
            type="text"
            id="name"
            value={channel.name}
            disabled
            class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-500 cursor-not-allowed"
          />
          <p class="text-xs text-gray-500 mt-1">
            Channel name cannot be changed after creation.
          </p>
        </div>

        <!-- Display Title -->
        <div>
          <label for="display_title" class="block text-sm font-medium text-gray-700 mb-2">
            Display Title <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="display_title"
            name="display_title"
            required
            value={channel.display_title}
            placeholder="e.g., Web Development Tutorials"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">
            User-friendly title shown in the UI.
          </p>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
            Description <span class="text-gray-400">(optional)</span>
          </label>
          <textarea
            id="description"
            name="description"
            rows="4"
            placeholder="e.g., Learn web development with tutorials on React, Vue, and more..."
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          >{channel.description || ''}</textarea>
          <p class="text-xs text-gray-500 mt-1">
            Brief description of the channel's content.
          </p>
        </div>

        <!-- Channel Status -->
        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Channel Status</h3>
          <p class="text-sm text-gray-600">
            Status: {channel.is_active ? (
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                ‚úÖ Active
              </span>
            ) : (
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                ‚ùå Inactive
              </span>
            )}
          </p>
          <p class="text-xs text-gray-500 mt-2">
            To deactivate this channel, use the Delete button on the channels list.
          </p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm"></div>

        <!-- Form Actions -->
        <div class="flex space-x-3">
          <button
            type="submit"
            id="submit-btn"
            class="px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Save Changes
          </button>
          <a
            href="/admin/channels"
            class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 transition"
          >
            Cancel
          </a>
        </div>
      </form>
    </div>

    <!-- Quick Actions -->
    <div class="mt-6 flex space-x-4">
      <a
        href={`/admin/channels/${channel.id}/videos`}
        class="flex-1 bg-white border border-gray-300 rounded-md p-4 hover:bg-gray-50 transition text-center"
      >
        <span class="text-2xl block mb-2">üé¨</span>
        <span class="text-sm font-medium text-gray-700">Manage Videos</span>
      </a>
    </div>
  </div>

  <!-- Form Submission Script -->
  <script>
    import { updateChannel } from '../../../../lib/admin-api';
    import { getClientToken, showToast } from '../../../../lib/admin-auth';

    const form = document.getElementById('edit-channel-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;

    // Get auth token
    const token = getClientToken();

    if (!token) {
      errorMessage.textContent = 'Authentication required. Please log in again.';
      errorMessage.classList.remove('hidden');
      submitBtn.disabled = true;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!token) return;

      // Get form data
      const formData = new FormData(form);
      const channelId = formData.get('channel_id') as string;
      const display_title = (formData.get('display_title') as string).trim();
      const description = (formData.get('description') as string).trim() || undefined;

      // Hide previous errors
      errorMessage.classList.add('hidden');

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      try {
        // Update channel
        await updateChannel(token, channelId, {
          display_title,
          description,
        });

        // Success - redirect to channels list
        showToast('Channel updated successfully! Redirecting...', 'success');
        setTimeout(() => {
          window.location.href = '/admin/channels';
        }, 1500);
      } catch (error) {
        console.error('Failed to update channel:', error);
        errorMessage.textContent = `Failed to update channel: ${error}`;
        errorMessage.classList.remove('hidden');

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
      }
    });
  </script>
</AdminLayout>
