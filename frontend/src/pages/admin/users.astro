---
/**
 * Users List Page
 *
 * Displays all users in a table with:
 * - User info (email, role, transcript count)
 * - Created date
 * - Delete button (cannot delete yourself)
 */

import AdminLayout from '../../layouts/AdminLayout.astro';
import { requireAdmin } from '../../lib/admin-auth';
import { listUsers, type User } from '../../lib/admin-api';

// Auth check
const auth = await requireAdmin(Astro);
if (auth instanceof Response) return auth;

// Fetch users
let users: User[] = [];
let total = 0;
let error: string | null = null;

try {
  const response = await listUsers(auth.token);
  users = response.users;
  total = response.total;
} catch (err) {
  console.error('Failed to fetch users:', err);
  error = 'Failed to load users. Please try again.';
}

// Get current user ID for self-deletion prevention
const currentUserId = auth.user.id;
---

<AdminLayout title="Users" auth={auth}>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">User Management</h1>
        <p class="text-gray-600 mt-1">Manage all user accounts and permissions</p>
      </div>
      <div class="flex flex-col items-end gap-3">
        <!-- Registration Toggle -->
        <label class="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            id="registrationToggle"
            class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
          />
          <span class="text-sm text-gray-700">Allow new user registrations</span>
        </label>

        <!-- Create User Button -->
        <button
          id="createUserBtn"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition"
        >
          + Create New User
        </button>

        <div class="text-sm text-gray-600">
          Total: <span class="font-semibold">{total}</span> users
        </div>
      </div>
    </div>

    <!-- Error Message -->
    {error && (
      <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
        {error}
      </div>
    )}

    <!-- Users Table -->
    {users.length === 0 && !error ? (
      <div class="bg-white rounded-lg shadow p-12 text-center">
        <div class="text-6xl mb-4">üë•</div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No users found</h3>
        <p class="text-gray-600">No users in the system.</p>
      </div>
    ) : (
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Email
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Role
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Transcripts
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Created
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {users.map((user) => (
              <tr class="hover:bg-gray-50">
                <!-- Email -->
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <div class="text-sm font-medium text-gray-900">
                      {user.email}
                    </div>
                    {user.id === currentUserId && (
                      <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        You
                      </span>
                    )}
                  </div>
                </td>

                <!-- Role Badge -->
                <td class="px-6 py-4 whitespace-nowrap">
                  {user.role === 'admin' ? (
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                      üîë Admin
                    </span>
                  ) : (
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                      üë§ User
                    </span>
                  )}
                </td>

                <!-- Transcript Count -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {user.transcript_count} videos
                </td>

                <!-- Created Date -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {new Date(user.created_at).toLocaleDateString()}
                </td>

                <!-- Actions -->
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  {user.id === currentUserId ? (
                    <span class="text-gray-400 italic">Cannot modify yourself</span>
                  ) : (
                    <div class="flex justify-end gap-2">
                      <button
                        data-user-id={user.id}
                        data-user-email={user.email}
                        class="reset-password-btn inline-block px-3 py-1 text-yellow-600 hover:text-yellow-900 border border-yellow-600 rounded hover:bg-yellow-50 transition"
                      >
                        Reset Password
                      </button>
                      <button
                        data-user-id={user.id}
                        data-user-email={user.email}
                        class="delete-btn inline-block px-3 py-1 text-red-600 hover:text-red-900 border border-red-600 rounded hover:bg-red-50 transition"
                      >
                        Delete
                      </button>
                    </div>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </div>

  <!-- Create User Modal -->
  <div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Create New User</h2>

      <form id="createUserForm" class="space-y-4">
        <div>
          <label for="newUserEmail" class="block text-sm font-medium text-gray-700 mb-1">
            Email Address
          </label>
          <input
            type="email"
            id="newUserEmail"
            name="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="user@example.com"
          />
        </div>

        <div id="generatedPasswordSection" class="hidden space-y-2">
          <div class="bg-green-50 border border-green-200 rounded-md p-4">
            <p class="text-sm font-medium text-green-800 mb-2">User created successfully!</p>
            <p class="text-sm text-green-700 mb-3">
              Generated password (save this - it won't be shown again):
            </p>
            <div class="flex items-center gap-2">
              <code id="generatedPassword" class="flex-1 bg-white px-3 py-2 rounded border border-green-300 text-sm font-mono"></code>
              <button
                type="button"
                id="copyPasswordBtn"
                class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition"
              >
                Copy
              </button>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button
            type="button"
            id="cancelCreateBtn"
            class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="submitCreateBtn"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition disabled:opacity-50"
          >
            Create User
          </button>
          <button
            type="button"
            id="doneCreateBtn"
            class="hidden px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition"
          >
            Done
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div id="resetPasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Password Reset Successful</h2>

      <div class="space-y-4">
        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
          <p class="text-sm font-medium text-yellow-800 mb-2">
            ‚ö†Ô∏è Save this password - it will only be shown once!
          </p>
          <p class="text-sm text-yellow-700 mb-3">
            New password for <span id="resetUserEmail" class="font-semibold"></span>:
          </p>
          <div class="flex items-center gap-2">
            <code id="resetGeneratedPassword" class="flex-1 bg-white px-3 py-2 rounded border border-yellow-300 text-sm font-mono break-all"></code>
            <button
              type="button"
              id="copyResetPasswordBtn"
              class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded transition whitespace-nowrap"
            >
              Copy
            </button>
          </div>
        </div>

        <div class="flex justify-end">
          <button
            type="button"
            id="doneResetBtn"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"
          >
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    import { deleteUser, createUser, resetUserPassword, getRegistrationStatus, setRegistrationStatus } from '@/lib/admin-api';
    import { getClientToken, showToast, showConfirm } from '@/lib/admin-auth';

    // Get authentication token
    const token = getClientToken();

    // ============================================================================
    // Registration Toggle
    // ============================================================================

    const registrationToggle = document.getElementById('registrationToggle') as HTMLInputElement;

    // Load initial registration status
    async function loadRegistrationStatus() {
      try {
        const status = await getRegistrationStatus(token);
        registrationToggle.checked = status.enabled;
      } catch (error) {
        console.error('Failed to load registration status:', error);
        showToast('Failed to load registration status', 'error');
      }
    }

    // Handle registration toggle
    registrationToggle.addEventListener('change', async (e) => {
      const enabled = (e.target as HTMLInputElement).checked;

      try {
        await setRegistrationStatus(token, enabled);
        showToast(`User registration ${enabled ? 'enabled' : 'disabled'}`, 'success');
      } catch (error) {
        console.error('Failed to update registration status:', error);
        showToast('Failed to update registration status', 'error');
        // Revert checkbox
        registrationToggle.checked = !enabled;
      }
    });

    // Load status on page load
    loadRegistrationStatus();

    // ============================================================================
    // Create User Modal
    // ============================================================================

    const createUserBtn = document.getElementById('createUserBtn') as HTMLButtonElement;
    const createUserModal = document.getElementById('createUserModal') as HTMLDivElement;
    const createUserForm = document.getElementById('createUserForm') as HTMLFormElement;
    const cancelCreateBtn = document.getElementById('cancelCreateBtn') as HTMLButtonElement;
    const doneCreateBtn = document.getElementById('doneCreateBtn') as HTMLButtonElement;
    const emailInput = document.getElementById('newUserEmail') as HTMLInputElement;
    const generatedPasswordSection = document.getElementById('generatedPasswordSection') as HTMLDivElement;
    const generatedPassword = document.getElementById('generatedPassword') as HTMLElement;
    const copyPasswordBtn = document.getElementById('copyPasswordBtn') as HTMLButtonElement;
    const submitCreateBtn = document.getElementById('submitCreateBtn') as HTMLButtonElement;

    // Open modal
    createUserBtn.addEventListener('click', () => {
      createUserModal.classList.remove('hidden');
      emailInput.focus();
    });

    // Close modal
    function closeModal() {
      createUserModal.classList.add('hidden');
      createUserForm.reset();
      generatedPasswordSection.classList.add('hidden');
      submitCreateBtn.classList.remove('hidden');
      doneCreateBtn.classList.add('hidden');
      emailInput.disabled = false;
    }

    cancelCreateBtn.addEventListener('click', closeModal);
    doneCreateBtn.addEventListener('click', () => {
      closeModal();
      window.location.reload();
    });

    // Close modal on backdrop click
    createUserModal.addEventListener('click', (e) => {
      if (e.target === createUserModal) {
        closeModal();
      }
    });

    // Handle form submission
    createUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim();
      if (!email) return;

      submitCreateBtn.disabled = true;
      submitCreateBtn.textContent = 'Creating...';

      try {
        const result = await createUser(token, email);

        // Show generated password
        generatedPassword.textContent = result.generated_password;
        generatedPasswordSection.classList.remove('hidden');

        // Hide submit button, show done button
        submitCreateBtn.classList.add('hidden');
        doneCreateBtn.classList.remove('hidden');
        emailInput.disabled = true;

        showToast('User created successfully!', 'success');
      } catch (error: any) {
        console.error('Failed to create user:', error);
        showToast(`Failed to create user: ${error}`, 'error');
        submitCreateBtn.disabled = false;
        submitCreateBtn.textContent = 'Create User';
      }
    });

    // Copy password to clipboard
    copyPasswordBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(generatedPassword.textContent || '');
        copyPasswordBtn.textContent = 'Copied!';
        setTimeout(() => {
          copyPasswordBtn.textContent = 'Copy';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy password:', error);
        showToast('Failed to copy password', 'error');
      }
    });

    // ============================================================================
    // Reset Password
    // ============================================================================

    const resetPasswordModal = document.getElementById('resetPasswordModal') as HTMLDivElement;
    const resetUserEmail = document.getElementById('resetUserEmail') as HTMLSpanElement;
    const resetGeneratedPassword = document.getElementById('resetGeneratedPassword') as HTMLElement;
    const copyResetPasswordBtn = document.getElementById('copyResetPasswordBtn') as HTMLButtonElement;
    const doneResetBtn = document.getElementById('doneResetBtn') as HTMLButtonElement;

    // Close reset modal
    function closeResetModal() {
      resetPasswordModal.classList.add('hidden');
      resetGeneratedPassword.textContent = '';
      resetUserEmail.textContent = '';
    }

    doneResetBtn.addEventListener('click', () => {
      closeResetModal();
      window.location.reload();
    });

    // Close on backdrop click
    resetPasswordModal.addEventListener('click', (e) => {
      if (e.target === resetPasswordModal) {
        closeResetModal();
      }
    });

    // Copy password to clipboard
    copyResetPasswordBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(resetGeneratedPassword.textContent || '');
        copyResetPasswordBtn.textContent = 'Copied!';
        setTimeout(() => {
          copyResetPasswordBtn.textContent = 'Copy';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy password:', error);
        showToast('Failed to copy password', 'error');
      }
    });

    // Attach reset password handlers to all reset buttons
    document.querySelectorAll('.reset-password-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const userId = button.dataset.userId;
        const userEmail = button.dataset.userEmail;

        if (!userId || !token) return;

        // Confirm reset
        const confirmed = await showConfirm(
          `‚ö†Ô∏è Reset password for "${userEmail}"?\n\n` +
          `A new secure password will be generated and shown once.\n` +
          `The user will need this new password to log in.\n\n` +
          `Continue?`,
          'Reset Password',
          'Yes, Reset Password',
          'Cancel'
        );

        if (!confirmed) return;

        // Disable button during API call
        button.disabled = true;
        button.textContent = 'Resetting...';

        try {
          const result = await resetUserPassword(token, userId);

          // Show password in modal
          resetUserEmail.textContent = userEmail;
          resetGeneratedPassword.textContent = result.generated_password;
          resetPasswordModal.classList.remove('hidden');

          showToast(`Password reset for ${userEmail}!`, 'success');
        } catch (error: any) {
          console.error('Reset password failed:', error);
          showToast(`Failed to reset password: ${error}`, 'error', 5000);
          button.disabled = false;
          button.textContent = 'Reset Password';
        }
      });
    });

    // ============================================================================
    // Delete User
    // ============================================================================

    // Attach delete handlers to all delete buttons
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const userId = button.dataset.userId;
        const userEmail = button.dataset.userEmail;

        if (!userId || !token) return;

        // Confirm deletion
        const confirmed = await showConfirm(
          `‚ö†Ô∏è WARNING: Permanently delete user "${userEmail}"?\n\n` +
          `This will PERMANENTLY DELETE:\n` +
          `‚Ä¢ User account and credentials\n` +
          `‚Ä¢ All user sessions\n` +
          `‚Ä¢ All transcripts and chunks\n` +
          `‚Ä¢ All conversations and messages\n` +
          `‚Ä¢ All channel conversations\n\n` +
          `‚ö†Ô∏è THIS ACTION CANNOT BE UNDONE!\n\n` +
          `You will need to type "DELETE" in the next prompt to confirm.`,
          'Delete User',
          'Continue',
          'Cancel'
        );

        if (!confirmed) return;

        // Secondary confirmation
        const confirmText = prompt('Type "DELETE" to confirm permanent deletion:');
        if (confirmText !== 'DELETE') {
          showToast('Deletion cancelled. You must type "DELETE" to confirm.', 'info');
          return;
        }

        // Delete user
        button.disabled = true;
        button.textContent = 'Deleting...';

        try {
          await deleteUser(token, userId);
          showToast('User deleted successfully! Refreshing...', 'success');
          setTimeout(() => window.location.reload(), 1500);
        } catch (error) {
          console.error('Delete failed:', error);
          showToast(`Failed to delete user: ${error}`, 'error', 5000);
          button.disabled = false;
          button.textContent = 'Delete';
        }
      });
    });
  </script>
</AdminLayout>
